turn_on_felix_rum:
  alias: Tänd Felix rum
  sequence:
  - service: homeassistant.turn_on
    data:
      entity_id: group.felix_rum
turn_off_felix_rum:
  alias: Släck Felix rum
  sequence:
  - service: homeassistant.turn_off
    data:
      entity_id: group.felix_rum
turn_on_uppe:
  alias: Tänd övervån
  sequence:
  - service: homeassistant.turn_on
    data: {}
    target:
      entity_id:
      - group.vrum_uppe
      - group.sovrummet
      - group.kontoret
  mode: single
turn_off_uppe:
  alias: Släck övervån
  sequence:
  - service: homeassistant.turn_off
    data: {}
    target:
      entity_id:
      - group.sovrummet
      - group.kontoret
      - group.vrum_uppe
  mode: single
turn_on_nere:
  alias: Tänd undervån
  sequence:
  - service: homeassistant.turn_on
    data:
      entity_id:
      - group.grovkoket
      - group.koket
      - group.vrum_nere
      - group.hallen
      - group.gastrummet
      - group.felix_rum
  - service: light.turn_on
    data:
      entity_id:
      - group.vrum_nere
      - group.koket
    enabled: false
  mode: single
turn_off_nere:
  alias: Släck undervån
  sequence:
  - service: homeassistant.turn_off
    data:
      entity_id:
      - group.grovkoket
      - group.koket
      - group.vrum_nere
      - group.hallen
      - group.gastrummet
      - group.felix_rum
  mode: single
turn_on_general_lights:
  alias: Tänd allmän belysning
  sequence:
  - service: homeassistant.turn_on
    data:
      entity_id:
      - group.grovkoket
      - group.koket
      - group.vrum_nere
      - group.hallen
      - group.gastrummet
      - group.sovrummet
      - group.vrum_uppe
      - group.kontoret
  - service: light.turn_on
    data:
      brightness_pct: 35
    target:
      entity_id: light.spelrummet_fonstret
  - service: light.turn_on
    data:
      brightness_pct: 55
    target:
      entity_id: light.byran_uppe_light
  mode: restart
turn_off_general_lights:
  alias: Släck allmän belysning
  sequence:
  - service: homeassistant.turn_off
    data: {}
    target:
      entity_id:
      - group.grovkoket
      - group.koket
      - group.vrum_nere
      - group.hallen
      - group.gastrummet
      - group.vrum_uppe
      - group.kontoret
      - switch.rusta13a
      - switch.rusta13c
      - group.sovrummet
  - if:
    - condition: state
      entity_id: script.turn_on_general_lights
      state: 'on'
    then:
    - service: script.turn_off
      data: {}
      target:
        entity_id: script.turn_on_general_lights
  mode: restart
turn_off_all:
  alias: Stäng av allt
  sequence:
  - service: homeassistant.turn_off
    data:
      entity_id:
      - group.grovkoket
      - group.koket
      - group.vrum_nere
      - group.hallen
      - group.gastrummet
      - group.sovrummet
      - group.vrum_uppe
      - group.kontoret
      - group.felix_rum
      - group.ute
  mode: single
turn_on_outdoor:
  alias: Slå på utomhusbelysning
  sequence:
  - service: homeassistant.turn_on
    data: {}
    target:
      entity_id: group.ute
  mode: single
turn_off_outdoor:
  alias: Slå av utomhusbelysning
  sequence:
  - service: homeassistant.turn_off
    data: {}
    target:
      entity_id: group.ute
turn_on_all_lights:
  alias: Tänd belysning
  sequence:
  - service: homeassistant.turn_on
    data:
      entity_id:
      - group.grovkoket
      - group.koket
      - group.vrum_nere
      - group.hallen
      - group.gastrummet
      - group.sovrummet
      - group.vrum_uppe
      - group.kontoret
      - group.felix_rum
  mode: single
turn_on_morning_lights:
  alias: Tänd morgonbelysning
  sequence:
  - service: homeassistant.turn_on
    data: {}
    target:
      entity_id:
      - group.grovkoket
      - group.koket
      - group.hallen
      - light.office_window
      - light.fibaro_system_fgd212_dimmer_2_level_2
      - group.sovrummet
      - switch.tz3000_2_byran_uppe_switch
  - service: light.turn_on
    data:
      brightness_pct: 1
    target:
      entity_id: light.spelrummet_fonstret
  mode: single
early_morning_lights_on:
  alias: Tänd tidig morgon
  sequence:
  - service: homeassistant.turn_on
    data: {}
    target:
      entity_id:
      - group.grovkoket
      - group.koket
      - group.hallen
      - switch.nexa_1
  - service: light.turn_on
    data:
      brightness_pct: 10
    target:
      entity_id: light.byran_uppe_light
    alias: Turn on Byrån uppe, low light
  mode: single
start_the_car:
  alias: EV6, Start Car
  sequence:
  - service: lock.unlock
    data: {}
    target:
      entity_id:
      - lock.ev6_door_lock
    alias: Unlock
  - service: script.ev6_start_hvac
    data: {}
    alias: Start HVAC
  mode: single
  description: ''
charge_the_tesla:
  alias: EV6, Charge
  sequence:
  - alias: Try to add EV6 to queue
    metadata: {}
    data:
      sequence:
      - action: rest_command.cn_add_rya_to_queue
        data: {}
    action: retry.actions
  - data:
      title: EV6 börjar ladda
      data:
        persistent: true
        sticky: true
        tag: car_1_charging
        channel: ev
        clickAction: /lovelace/tesla
      message: 'SoC:    {{states("sensor.ev6_ev_battery_level") }}%\n Priset: {{states("sensor.template_nordpool_current_price_vat")}}
        kr\n {{now().strftime(''%d %H:%M'')}}'
    alias: Notify Charge starting
    action: notify.rickards_devices
  - delay:
      hours: 0
      minutes: 2
      seconds: 0
      milliseconds: 0
  - target:
      entity_id: sensor.charge_rya_sessionid
    data: {}
    alias: Get SessionId
    action: homeassistant.update_entity
  - data: {}
    action: kia_uvo.force_update
  mode: single
  icon: mdi:ev-station
  description: ''
slack_inne:
  sequence:
  - service: homeassistant.turn_off
    data: {}
    target:
      entity_id:
      - group.hallen
      - switch.rusta13c
      - switch.rusta13a
      - group.gastrummet
      - group.grovkoket
      - switch.nexa_1
      - switch.tz2
  mode: single
  alias: Släck inne
  icon: mdi:lightbulb-group-off-outline
ladda_tesla_stoppa:
  alias: 'EV6, Stop Charge '
  sequence:
  - service: rest_command.cn_remove_rya_from_queue
    data: {}
  - service: notify.rickards_devices
    data:
      message: 'SoC:    {{states("sensor.ev6_ev_battery_level")}}%\n Priset: {{states("sensor.template_nordpool_current_price_vat")}}
        kr\n {{now().strftime(''%m-%d %H:%M'')}}'
      title: EV6 har laddat färdigt
      data:
        clickAction: /lovelace/tesla
        channel: ev
  mode: single
  icon: mdi:ev-station
  description: ''
ladda_bilen_uppstart:
  alias: Ladda bilarna, uppstart
  sequence:
  - alias: Set variables
    variables:
      state_spa_heater: '{{ states(''switch.spabadet_l2'') }}'
      state_vp_cartridge: '{{ states(''switch.varmepumpen_b'') }}'
  - data: {}
    target:
      entity_id: switch.spabadet_l2
    alias: Turn off Spa Heater
    action: switch.turn_off
  - alias: Turn off VP Elec Cartridge
    data: {}
    target:
      entity_id:
      - switch.varmepumpen_b
    enabled: true
    action: switch.turn_on
  - alias: Turn off VP Heat & Hot Water
    data: {}
    enabled: false
    action: switch.turn_on
    target:
      entity_id: switch.varmepumpen_a
  - delay:
      hours: 0
      minutes: 5
      seconds: 0
      milliseconds: 0
  - alias: If Nordpool low price
    if:
    - condition: state
      entity_id: sensor.nordpool_kwh_se3_sek_3_095_0
      attribute: low_price
      state: true
      alias: Confirm Nordpool low price
    then:
    - data: {}
      target:
        entity_id: switch.spabadet_l2
      alias: Turn on Spa Heater
      action: switch.turn_on
    - alias: Turn on VP Elec Cartridge
      data: {}
      target:
        entity_id:
        - switch.varmepumpen_b
      enabled: true
      action: switch.turn_off
    - alias: Turn on VP Heat and Hot water
      data: {}
      target:
        entity_id:
        - switch.varmepumpen_a
      enabled: false
      action: switch.turn_off
    enabled: false
  - alias: Restore Hot Tub state
    action: switch.turn_{{state_spa_heater}}
    target:
      entity_id: switch.spabadet_l2
    enabled: false
  - alias: Restore VP Elec Cartridge state
    action: switch.turn_{{state_vp_cartridge}}
    target:
      entity_id: switch.varmepumpen_b
  - action: script.spabadet_pump_and_heater_v2
    metadata: {}
    data: {}
    alias: Run script to control Spa heater
  mode: single
  icon: mdi:ev-station
spabadet_pause_control:
  alias: Spabadet, pause control
  sequence:
  - alias: If manual control turn on automatic
    if:
    - condition: state
      entity_id: input_boolean.spabadet_manual
      state: 'on'
    then:
    - service: automation.turn_off
      data:
        stop_actions: true
      target:
        entity_id:
        - automation.spabadet_pump_and_heater
    - service: switch.turn_on
      data: {}
      target:
        entity_id:
        - switch.spabadet_l3
        - switch.spabadet_l2
      alias: Turn on pumps and heater
    - service: notify.rickards_devices
      data:
        title: Spabadet på
        data:
          tag: spa
          channel: Spa
          sticky: true
          clickAction: /lovelace/spa
        message: 'Kostnad: {{(states("sensor.spabadet_kr")|float - states("var.spa_cost")|float)|round(2)
          }} kr\n Priset:  {{states("sensor.template_elpris_kr") }} kr\n Klockan:
          {{now().strftime(''%H:%M'') }}\n Badet:   {{states("sensor.template_spabadet_temperature")
          }}°C'
      alias: Notify Rickard that manual control is turned on
    - alias: Spara kostnad när badet börjar
      service: var.set
      data:
        entity_id: var.spa_cost
        value_template: '{{ states(''sensor.spabadet_kr'')|float }}'
    else:
    - service: automation.turn_on
      target:
        entity_id: automation.spabadet_pump_and_heater
      data: {}
    - service: notify.rickards_devices
      data:
        title: Spabadet av
        data:
          tag: spa
          channel: Spa
          sticky: true
          clickAction: /lovelace/spa
        message: '{{states("sensor.template_spabadet_temperature")}}°C • {{states("sensor.template_home_temp")}}°C
          ute\n Kostnad: {{(states(''sensor.spabadet_kr'')|float - states("var.spa_cost")|float)|round(2)}}
          kr\n {{now().strftime(''%H:%M'') }}'
      alias: Notify Rickard that manual control is turned off
    - if:
      - condition: state
        entity_id: binary_sensor.template_nordpool_price_reallow
        state: 'off'
        alias: If not cheap
      then:
      - service: switch.turn_off
        data: {}
        target:
          entity_id: switch.spabadet_l2
        alias: Turn off Heat
      alias: 'If not cheap turn off Heat '
  mode: single
  icon: mdi:swim
spabadet_pump_and_heater_v2:
  alias: Spabadet, pump and heater (V2)
  sequence:
  - alias: Control heater
    if:
    - alias: Spabadet < 30° or Low price
      condition: or
      conditions:
      - alias: Spabadet < lower temp limit
        condition: numeric_state
        entity_id: sensor.template_spabadet_temperature
        below: input_number.spabadet_lower_temp_limit
        enabled: true
      - condition: state
        entity_id: binary_sensor.template_nordpool_price_low
        state: 'on'
        alias: Median low price
        enabled: false
      - condition: state
        entity_id: binary_sensor.template_nordpool_price_reallow
        state: 'on'
        alias: Below 25%
        enabled: true
    - condition: or
      conditions:
      - alias: I veckan
        condition: and
        conditions:
        - condition: time
          weekday:
          - mon
          - tue
          - wed
          - thu
          - sun
          alias: Inte helg
        - condition: template
          value_template: "{{ \n  (now().weekday() not in [4, 5] and \n   states('sensor.template_spabadet_temperature')
            | float < states('input_number.spabadet_target_temp_weekdays') | float)
            \n}}\n"
          alias: Temp under målet (vecka)
      - condition: and
        conditions:
        - condition: time
          weekday:
          - fri
          - sat
          alias: Är helg
        - condition: template
          value_template: "{{ (now().weekday() in [4, 5] and \n   states('sensor.template_spabadet_temperature')
            | float < states('input_number.spabadet_target_temp_weekends') | float)
            }}"
          alias: Temp under målet (helg)
        alias: Är helg
    then:
    - data: {}
      target:
        entity_id:
        - switch.spabadet_l2
      alias: Turn on heater
      action: switch.turn_on
    else:
    - data: {}
      target:
        entity_id:
        - switch.spabadet_l2
      alias: Turn off heater
      action: switch.turn_off
  - alias: Control pump
    if:
    - alias: Every four hours, Low price, Spabadet < 30° or Temp < 0°
      condition: or
      conditions:
      - alias: Temp < 0°
        condition: numeric_state
        entity_id: sensor.template_home_temp
        below: 0
      - alias: Spabadet < 30°
        condition: numeric_state
        entity_id: sensor.template_spabadet_temperature
        below: input_number.spabadet_lower_temp_limit
      - condition: state
        entity_id: binary_sensor.template_nordpool_price_low
        state: 'on'
        alias: Median low price
        enabled: false
      - condition: state
        entity_id: binary_sensor.template_nordpool_price_reallow
        state: 'on'
        alias: Below 25%
        enabled: true
      - condition: and
        conditions:
        - condition: template
          value_template: '{{now().hour % 4 == 0}}'
          alias: Every four hours
        - condition: numeric_state
          entity_id: sensor.spabadet_paslaget_min_24_hrs
          below: 420
          alias: When Spa has ran <7 hrs
        alias: Every 4h when On <7h
    then:
    - data: {}
      target:
        entity_id:
        - switch.spabadet_l3
      alias: Turn on pump
      action: switch.turn_on
    else:
    - data: {}
      target:
        entity_id:
        - switch.spabadet_l3
      alias: Turn off pump
      action: switch.turn_off
  mode: single
  icon: mdi:pump
tvattmaskinen_aktivera_timer:
  alias: Tvättmaskinen, aktivera timer
  sequence:
  - service: automation.turn_on
    data: {}
    target:
      entity_id:
      - automation.tvattmaskinen_starta_pa_klockslag
      - automation.tvattmaskinen_starta
  - service: input_datetime.set_datetime
    data:
      time: '{{ as_timestamp(state_attr(''sensor.peaqnext_washing_machine'',''raw_start''))|timestamp_custom(''%H:%M:%S'')
        }}'
    target:
      entity_id: input_datetime.tvattmaskinen_timme
  mode: single
  icon: mdi:dishwasher-alert
ev6_start_hvac:
  alias: EV6, start HVAC
  sequence:
  - alias: Choose AC or Heat
    choose:
    - conditions:
      - condition: numeric_state
        entity_id: sensor.template_home_temp
        below: 14
        above: 5.1
      sequence:
      - alias: Set Heat to 22°
        data:
          duration: 10
          climate: true
          temperature: 22
          heating: '0'
          device_id: f4c09575234da651122f411210842a80
        action: kia_uvo.start_climate
    - conditions:
      - condition: numeric_state
        entity_id: sensor.template_home_temp
        below: 5
      sequence:
      - alias: Set Heat to 22° and turn on Defrost on EV6
        data:
          duration: 10
          climate: true
          temperature: 22
          heating: '3'
          device_id: f4c09575234da651122f411210842a80
          defrost: true
        action: kia_uvo.start_climate
    default:
    - alias: Set temp to 22° on EV6
      data:
        duration: 10
        climate: true
        temperature: 21
        heating: '0'
        device_id: f4c09575234da651122f411210842a80
      action: kia_uvo.start_climate
  - delay:
      hours: 0
      minutes: 0
      seconds: 5
      milliseconds: 0
  - data: {}
    target:
      device_id: f4c09575234da651122f411210842a80
    action: homeassistant.reload_config_entry
  - repeat:
      while:
      - condition: state
        entity_id: binary_sensor.ev6_air_conditioner
        state: 'off'
      - condition: template
        value_template: '{{ repeat.index <= 60 }}'
        alias: Repeat max 60 times (10 mins)
      sequence:
      - delay:
          hours: 0
          minutes: 0
          seconds: 10
          milliseconds: 0
      - data: {}
        alias: Update EV6 from cache
        action: kia_uvo.update
  - variables:
      action_keepon: '{{ ''KEEPON_'' ~ context.id }}'
      action_turnoff: '{{ ''TURNOFF_'' ~ context.id }}'
    enabled: false
  - repeat:
      sequence:
      - alias: Notify Rickard that HVAC is running
        data:
          message: 'AC kör i 15 minuter.\n {{states(''sensor.ev6_ev_battery_level'')}}%
            • {{states(''sensor.ev6_set_temperature'')}}°C\n {{now().strftime(''%H:%M'')}}          '
          data:
            channel: ev
            tag: ev_hvac
            sticky: true
            click_action: /lovelace/tesla
        action: notify.mobile_app_op9_pro
      - delay:
          minutes: 15
      - if:
        - condition: state
          entity_id: input_boolean.rya_hvac_on
          state: 'on'
        then:
        - alias: Ask Rickard to stop or continue
          data:
            title: AC kör fortfarande på EV6
            data:
              channel: ev
              tag: ev_hvac
              sticky: true
              persistent: true
              click_action: /lovelace/tesla
              actions:
              - action: '{{ action_keepon }}'
                title: Fortsätt
              - action: '{{ action_turnoff }}'
                title: Stäng av
            message: Vill du köra 15 minuter till?\n {{states('sensor.ev6_ev_battery_level')}}%
              • {{states('sensor.ev6_set_temperature')}}°C\n AC {{states('binary_sensor.ev6_air_conditioner')}}
              ({{ states.binary_sensor.ev6_air_conditioner.last_updated|as_local|as_timestamp|timestamp_custom('%m-%d
              %H:%M')}})\n (Kört {{repeat.index}} gång(er))\n               {{now().strftime('%H:%M')}}
          action: notify.mobile_app_op9_pro
        - wait_for_trigger:
          - event_type: mobile_app_notification_action
            event_data:
              action: '{{ action_keepon }}'
            trigger: event
          - event_type: mobile_app_notification_action
            event_data:
              action: '{{ action_turnoff }}'
            trigger: event
          - event_type: mobile_app_notification_cleared
            event_data:
              action_1_key: '{{ action_keepon }}'
            trigger: event
          timeout:
            minutes: 1
        - data:
            message: clear_notification
            data:
              tag: ev_hvac
          alias: Clear persistent notification
          action: notify.rickards_devices
        - choose:
          - conditions:
            - condition: template
              value_template: '{{ wait.trigger.event.data.action == action_keepon
                }}'
            sequence:
            - alias: Set temp to 21° on EV6
              data:
                duration: 10
                climate: true
                temperature: 21
                heating: false
                device_id: f4c09575234da651122f411210842a80
              enabled: true
              action: kia_uvo.start_climate
            - delay:
                hours: 0
                minutes: 0
                seconds: 15
                milliseconds: 0
              enabled: true
            - data: {}
              alias: Refresh EV6 from cache
              action: kia_uvo.update
          default:
          - target:
              entity_id: input_boolean.rya_hvac_on
            alias: Turn off EV6 HVAC
            data: {}
            action: input_boolean.turn_off
        alias: Check AC still is on
      while:
      - condition: template
        alias: While AC is on but no more than 3 times
        value_template: '{{ repeat.index < 4 and states(''input_boolean.rya_hvac_on'')
          == ''on'' }}'
    enabled: false
  - alias: Notify Rickard that HVAC is running
    data:
      message: AC kör i 15 minuter.\n {{states('sensor.ev6_ev_battery_level')}}% •
        {{states('sensor.ev6_set_temperature')}}°C
      data:
        channel: ev
        tag: ev_hvac
        sticky: true
        click_action: /lovelace/tesla
    action: notify.rickards_devices
  mode: single
  icon: mdi:fan-auto
ev6_lock_door:
  alias: EV6, Lock Door
  sequence:
  - device_id: f4c09575234da651122f411210842a80
    domain: lock
    entity_id: b08be94101111d34f139c1ea5cd906f9
    type: lock
  - delay:
      hours: 0
      minutes: 0
      seconds: 5
      milliseconds: 0
  - action: kia_uvo.update
    data: {}
  description: ''
  icon: mdi:car-door-lock
ev6_simple_heat:
  alias: EV6, Simple Heat
  sequence:
  - alias: Set Heat to 22° on EV6
    data:
      duration: 10
      climate: true
      temperature: 22
      heating: '3'
      device_id: f4c09575234da651122f411210842a80
      flseat: '8'
    action: kia_uvo.start_climate
  description: ''
movie_time:
  sequence:
  - if:
    - condition: or
      conditions:
      - condition: state
        entity_id: switch.tz3000_1_brudkistan_switch
        state: 'on'
      - condition: state
        entity_id: switch.tz3000_2_byran_uppe_switch
        state: 'on'
      - condition: state
        entity_id: switch.tz2
        state: 'on'
      alias: Any Lights are ON
    then:
    - action: switch.turn_off
      metadata: {}
      data: {}
      target:
        entity_id:
        - switch.tz2
        - switch.tz3000_2_byran_uppe_switch
        - switch.tz3000_1_brudkistan_switch
    else:
    - action: switch.turn_on
      metadata: {}
      data: {}
      target:
        entity_id:
        - switch.tz2
        - switch.tz3000_2_byran_uppe_switch
        - switch.tz3000_1_brudkistan_switch
    alias: Toggle Lights
  alias: Movie Time
  description: ''
  icon: mdi:projector-screen
