# bilar
- sensor:
  - unique_id: chargenode_energy_kwh
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    name: "ChargeNode [kWh]"
    state: >-
      {% if states('sensor.chargenode_energy')|is_number and
            states('sensor.chargenode_energy')|float(0) > 0 -%}
        {{states('sensor.chargenode_energy')|float(0)}}
      {%- else -%}
        {{ this.state }}
      {%- endif -%}
  - unique_id: chargenode_power_kw
    unit_of_measurement: "kW"
    device_class: power
    state_class: measurement
    name: "ChargeNode effekt [kW]"
    state: >-
      {{ states('sensor.chargenode_power_l1')|float(0) + states('sensor.chargenode_power_l2')|float(0) + states('sensor.chargenode_power_l3')|float(0) }}
      
## Zoe:n (car 2)
- sensor:
  - unique_id: zoe_battery
    unit_of_measurement: "%"
    state: "{{ states('sensor.byd_dolphin_soc')|int}}"
    name: "Delphine SoC [%]"
    icon: >-
      {% if states('sensor.byd_dolphin_soc')|int == 100 -%}
        mdi:battery
      {%- else -%}
        mdi:battery-{{(states('sensor.byd_dolphin_soc')|int/10)|round(0,'floor')*10}}
      {%- endif -%}
                                                              
  - unique_id: zoe_charging_power
    unit_of_measurement: "kW"
    device_class: power
    state_class: measurement
    name: "Delphine effekt [kW]"
    state: >-
      {% if is_state('sensor.chargenode_port2_state','3') -%}
        {{ states("sensor.template_chargenode_power_kw")|float(0) }}
      {%- else -%}
      {{ 0 | float }}
      {%- endif -%}
    
    # {{ states('sensor.chargenode_power_l1')|float(0) + states('sensor.chargenode_power_l2')|float(0) + states('sensor.chargenode_power_l3')|float(0) }}

  - unique_id: car_2_season_power
    unit_of_measurement: "kW"
    device_class: power
    state: "{{ states('input_number.car_2_power_high')|int if now().month > 2 and now().month < 10 else states('input_number.car_2_power_low')|int }}"
    name: "Delphine laddeffekt [kW]"

  - unique_id: zoe_charging_cost
    device_class: monetary
    unit_of_measurement: "kr"
    state: "{{ states('sensor.template_zoe_charging_power')|float(0) * states('sensor.template_elpris_kr')|float(0) }}"
  - unique_id: zoe_power_kw
    unit_of_measurement: "kW"
    device_class: power
    state_class: measurement
    state: "{{ states('sensor.template_zoe_charging_power')|float(0) }}"

  - unique_id: zoe_last_update
    state: "{{states.sensor.byd_dolphin_soc.last_updated|as_timestamp|timestamp_custom('%H:%M, %d %b')}}"
    name: "SoC senast uppdaterad (Delphine)"

  - unique_id: zoe_charging_required_time
    name: "Required charging time Delphine"
    state: >-      
      {%- set time = (states('input_number.zoe_soc_upper_limit')|float(0) - states('sensor.template_zoe_battery')|float(0)) /100*(states('input_number.car_2_battery')|int)/(states('sensor.template_car_2_season_power')|int) -%}
      {%- set hours = time|int -%}
      {%- set minutes = ((time - hours)*60)|int -%}
      {{ '{:02}:{:02}'.format(hours, minutes) }}
  - unique_id: zoe_req_hours
    state: >-
      {{ ((states('input_number.zoe_soc_upper_limit')|float(0) - states('sensor.byd_dolphin_soc')|int) /100*(states('input_number.car_2_battery')|int)/(states('sensor.template_car_2_season_power')|int) * 4)|round(0, 'ceil') / 4 }}

  - unique_id: zoe_charging_cost_last_period
    device_class: monetary
    unit_of_measurement: "kr"
    state: "{{ state_attr('sensor.zoe_kostnad','last_period')|float(0)|round(0) }}"

  - unique_id: car_2_range
    unit_of_measurement: "km"
    state: "{{ (states('sensor.template_zoe_battery')|int(0)*2.575)|round(0) }}"

  - unique_id: car_2_monthly_cost
    device_class: monetary
    unit_of_measurement: "kr"
    state: "{{ states('sensor.zoe_kostnad')|float(0) }}"
    name: 'Delphine Charge Cost'

## Tesla MY (car 1)
- sensor:
  - unique_id: car_1_season_power
    unit_of_measurement: "kW"
    device_class: power
    state: "{{ states('input_number.car_1_power_high')|int if now().month > 2 and now().month < 10 else states('input_number.car_1_power_low')|int }}"
    name: "Eazy laddeffekt (kW)"

  - unique_id: rya_charging_required_time
    name: "Required charging time Eazy"
    state: >-
      {%- set time = (states('sensor.tesla_charge_limit_soc')|float(0) - states('sensor.tesla_battery_level')|float(0)) /100*(states('input_number.car_1_battery')|int)/(states('sensor.template_car_1_season_power')|int) -%}
      {%- set hours = time|int -%}
      {%- set minutes = ((time - hours)*60)|int -%}
      {{ '{:02}:{:02}'.format(hours, minutes) }}
  - unique_id: rya_req_hours
    state: >-
      {{ ((states('sensor.tesla_charge_limit_soc')|float(0) - states('sensor.tesla_battery_level')|float(0)) /100*(states('input_number.car_1_battery')|int)/(states('sensor.template_car_1_season_power')|int) * 4)|round(0, 'ceil') / 4 }}

  - unique_id: rya_charging_power
    unit_of_measurement: "kW"
    device_class: power
    state_class: measurement
    name: "Eazy effekt (kW)"
    state: >-
      {% if is_state('sensor.chargenode_port1_state','3') -%}
        {{ states("sensor.template_chargenode_power_kw")|float(0) }}
      {%- else -%}
      {{ 0 | float }}
      {%- endif -%}
    
    # {{ states('sensor.chargenode_power_l1')|float(0) + states('sensor.chargenode_power_l2')|float(0) + states('sensor.chargenode_power_l3')|float(0) }}
  - unique_id: car_2_odometer
    unit_of_measurement: "km"
    name: 'Tesla Eazy Odometer'
    icon: mdi:counter
    state_class: total_increasing
    state: >-
      {{ states("sensor.tesla_odometer")|float(0)|round(0) }}
      
  - unique_id: rya_charging_cost
    device_class: monetary
    unit_of_measurement: "kr"
    state: "{{ states('sensor.template_rya_charging_power')|float(0) * states('sensor.template_elpris_kr')|float(0) }}"

  - unique_id: rya_charging_cost_last_period
    device_class: monetary
    unit_of_measurement: "kr"
    state: "{{ state_attr('sensor.rya_kostnad','last_period')|float(0)|round(0) }}"

  - unique_id: car_1_monthly_cost
    device_class: monetary
    unit_of_measurement: "kr"
    state: "{{ states('sensor.rya_kostnad')|float(0) }}"
    name: 'Tesla Eazy Charge Cost'

## Car 2 laddperiod
- trigger:
    - platform: time_pattern
      minutes: "/15"
    - platform: state
      entity_id: sensor.template_zoe_req_hours
      to:
    - platform: state
      entity_id: input_datetime.zoe_before
      to:
    - platform: state
      entity_id: automation.zoe_charge
      to:
    - platform: state
      entity_id: sensor.car_1_charge_period
      to:
  sensor:
  - unique_id: car_2_next_charge
    device_class: timestamp
    name: "Car 2 charge period"
    state: >-
      {% set duration = states('sensor.template_zoe_req_hours')|float(0) if is_state('automation.zoe_charge','on') else 0 %}
      {% if duration <= 0 -%}
        unavailable
      {%- else %}
        {% set before = today_at(states('input_datetime.zoe_before'))+timedelta(minutes=5)
            if now() < today_at(states('input_datetime.zoe_before'))
            else today_at(states('input_datetime.zoe_before'))+timedelta(days=1,minutes=5) %}
        {% set prices = state_attr('sensor.nordpool_kwh_se3_sek_3_095_0','raw_today')|list %}
        {% set tomorrow = state_attr('sensor.nordpool_kwh_se3_sek_3_095_0','raw_tomorrow')|list %}
        {% if tomorrow|length > 1 %}
          {% set prices = prices + tomorrow %}
        {% endif %}
        {% set other_state = states('sensor.car_1_charge_period') %}
        {% set other_dur = states('sensor.template_rya_req_hours')|float(0) if is_state('automation.ladda_bilen_nar_det_ar_billigt','on') else 0 %}
        {% set other_start = other_state|as_datetime if other_state not in ['unavailable','unknown'] and other_dur > 0 else none %}
        {% set other_end = other_start + timedelta(hours=other_dur) if other_start else none %}
        {% set best = namespace(start=none, cost=999999) %}
        {% set cutoff = now() - timedelta(minutes=55) %}
        {% for i in range(prices|length) %}
          {% set p = prices[i] %}
          {% if p.start >= cutoff and p.start < before %}
            {% set acc = namespace(eff=0.0, cost=0.0, end=none) %}
            {% for j in range(i, prices|length) %}
              {% if acc.end is none %}
                {% set q = prices[j] %}
                {% set overlaps = other_start is not none and q.start >= other_start and q.start < other_end %}
                {% set f = 0.5 if overlaps else 1.0 %}
                {% set acc.eff = acc.eff + f %}
                {% set acc.cost = acc.cost + q.value * f %}
                {% if acc.eff >= duration %}
                  {% set acc.end = q.start + timedelta(hours=1) %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {% if acc.end is not none and acc.end <= before and acc.cost < best.cost %}
              {% set best.start = p.start %}
              {% set best.cost = acc.cost %}
            {% endif %}
          {% endif %}
        {% endfor %}
        {% if best.start is not none %}
          {{ best.start }}
        {%- else %}
          unavailable
        {%- endif %}
      {%- endif %}
  - unique_id: car_2_next_charge_time
    state: "{{ states('sensor.car_2_charge_period')|as_timestamp(default=none)|timestamp_custom('%H:%M', default='—') }}"

## Car 1 laddperiod
- trigger:
    - platform: time_pattern
      minutes: "/15"
    - platform: state
      entity_id: sensor.template_rya_req_hours
      to:
    - platform: state
      entity_id: input_datetime.rya_before
      to:
    - platform: state
      entity_id: automation.ladda_bilen_nar_det_ar_billigt
      to:
    - platform: state
      entity_id: sensor.car_2_charge_period
      to:
  sensor:
  - unique_id: car_1_next_charge
    device_class: timestamp
    name: "Car 1 charge period"
    state: >-
      {% set duration = states('sensor.template_rya_req_hours')|float(0) if is_state('automation.ladda_bilen_nar_det_ar_billigt','on') else 0 %}
      {% if duration <= 0 -%}
        unavailable
      {%- else %}
        {% set before = today_at(states('input_datetime.rya_before'))+timedelta(minutes=5)
            if now() < today_at(states('input_datetime.rya_before'))
            else today_at(states('input_datetime.rya_before'))+timedelta(days=1,minutes=5) %}
        {% set prices = state_attr('sensor.nordpool_kwh_se3_sek_3_095_0','raw_today')|list %}
        {% set tomorrow = state_attr('sensor.nordpool_kwh_se3_sek_3_095_0','raw_tomorrow')|list %}
        {% if tomorrow|length > 1 %}
          {% set prices = prices + tomorrow %}
        {% endif %}
        {% set other_state = states('sensor.car_2_charge_period') %}
        {% set other_dur = states('sensor.template_zoe_req_hours')|float(0) if is_state('automation.zoe_charge','on') else 0 %}
        {% set other_start = other_state|as_datetime if other_state not in ['unavailable','unknown'] and other_dur > 0 else none %}
        {% set other_end = other_start + timedelta(hours=other_dur) if other_start else none %}
        {% set best = namespace(start=none, cost=999999) %}
        {% set cutoff = now() - timedelta(minutes=55) %}
        {% for i in range(prices|length) %}
          {% set p = prices[i] %}
          {% if p.start >= cutoff and p.start < before %}
            {% set acc = namespace(eff=0.0, cost=0.0, end=none) %}
            {% for j in range(i, prices|length) %}
              {% if acc.end is none %}
                {% set q = prices[j] %}
                {% set overlaps = other_start is not none and q.start >= other_start and q.start < other_end %}
                {% set f = 0.5 if overlaps else 1.0 %}
                {% set acc.eff = acc.eff + f %}
                {% set acc.cost = acc.cost + q.value * f %}
                {% if acc.eff >= duration %}
                  {% set acc.end = q.start + timedelta(hours=1) %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {% if acc.end is not none and acc.end <= before and acc.cost < best.cost %}
              {% set best.start = p.start %}
              {% set best.cost = acc.cost %}
            {% endif %}
          {% endif %}
        {% endfor %}
        {% if best.start is not none %}
          {{ best.start }}
        {%- else %}
          unavailable
        {%- endif %}
      {%- endif %}
  - unique_id: car_1_next_charge_time
    state: "{{ states('sensor.car_1_charge_period')|as_timestamp(default=none)|timestamp_custom('%H:%M', default='—') }}"

## Nästa billiga timme
- trigger:
    - platform: time_pattern
      minutes: "/15"
  sensor:
  - unique_id: next_low_price
    state: >-
      {% set priceDict = namespace(value = []) -%}
      {% set prices = state_attr('sensor.nordpool_kwh_se3_sek_3_095_0','raw_today')|list -%}
      {% set tomorrow = state_attr('sensor.nordpool_kwh_se3_sek_3_095_0','raw_tomorrow')|list -%}
      {% if tomorrow | length > 1 -%}
        {% set prices = prices + tomorrow -%}
      {% endif -%}
      {% for p in prices -%}
        {% set priceDict.value = priceDict.value + [(loop.index, (p.start, p.value))] -%}
      {% endfor -%}
      {% set dataDict = dict.from_keys(priceDict.value) -%}
      {% set priceDict.value = [] -%}
      {% for p in dataDict.items() -%}
        {% if (dataDict[loop.index][0] >= now() and (dataDict[loop.index][1]|float) < state_attr('sensor.nordpool_kwh_se3_sek_3_095_0', 'average')|float) -%}
          {% set priceDict.value = priceDict.value + [dataDict[loop.index][0]] -%}
        {% endif -%}
      {% endfor -%}
      {% if priceDict.value -%}
      {{ (priceDict.value|first).strftime('%H:%M') }}
      {% else -%}
        undefined
      {% endif -%}