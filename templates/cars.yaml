# bilar
- sensor:
  - unique_id: chargenode_energy_kwh
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    name: "ChargeNode [kWh]"
    state: >-
      {% if states('sensor.chargenode_energy')|is_number and
            states('sensor.chargenode_energy')|float(0) > 0 -%}
        {{states('sensor.chargenode_energy')|float(0)}}
      {%- else -%}
        {{ this.state }}
      {%- endif -%}
  - unique_id: chargenode_power_kw
    unit_of_measurement: "kW"
    device_class: power
    state_class: measurement
    name: "ChargeNode effekt [kW]"
    state: >-
      {{ states('sensor.chargenode_power_l1')|float(0) + states('sensor.chargenode_power_l2')|float(0) + states('sensor.chargenode_power_l3')|float(0) }}
      
## Zoe:n (car 2)
- sensor:
  - unique_id: zoe_battery
    unit_of_measurement: "%"
    state: "{{ states('sensor.byd_dolphin_soc')|int}}"
    name: "Delphine SoC [%]"
    icon: >-
      {% if states('sensor.byd_dolphin_soc')|int == 100 -%}
        mdi:battery
      {%- else -%}
        mdi:battery-{{(states('sensor.byd_dolphin_soc')|int/10)|round(0,'floor')*10}}
      {%- endif -%}
                                                              
  - unique_id: zoe_charging_power
    unit_of_measurement: "kW"
    device_class: power
    state_class: measurement
    name: "Delphine effekt [kW]"
    state: >-
      {% if is_state('sensor.chargenode_port2_state','3') -%}
        {{ states("sensor.template_chargenode_power_kw")|float(0) }}
      {%- else -%}
      {{ 0 | float }}
      {%- endif -%}
    
    # {{ states('sensor.chargenode_power_l1')|float(0) + states('sensor.chargenode_power_l2')|float(0) + states('sensor.chargenode_power_l3')|float(0) }}

  - unique_id: car_2_season_power
    unit_of_measurement: "kW"
    device_class: power
    state: "{{ states('input_number.car_2_power_high')|int if now().month > 2 and now().month < 10 else states('input_number.car_2_power_low')|int }}"
    name: "Delphine laddeffekt [kW]"

  - unique_id: zoe_charging_cost
    device_class: monetary
    unit_of_measurement: "kr"
    state: "{{ states('sensor.template_zoe_charging_power')|float(0) * states('sensor.template_elpris_kr')|float(0) }}"
  - unique_id: zoe_power_kw
    unit_of_measurement: "kW"
    device_class: power
    state_class: measurement
    state: "{{ states('sensor.template_zoe_charging_power')|float(0) }}"

  - unique_id: zoe_last_update
    state: "{{states.sensor.byd_dolphin_soc.last_updated|as_timestamp|timestamp_custom('%H:%M, %d %b')}}"
    name: "SoC senast uppdaterad (Delphine)"

  - unique_id: zoe_charging_required_time
    name: "Required charging time Delphine"
    state: >-      
      {%- set time = (states('input_number.zoe_soc_upper_limit')|float(0) - states('sensor.template_zoe_battery')|float(0)) /100*(states('input_number.car_2_battery')|int)/(states('sensor.template_car_2_season_power')|int) -%}
      {%- set hours = time|int -%}
      {%- set minutes = ((time - hours)*60)|int -%}
      {{ '{:02}:{:02}'.format(hours, minutes) }}
  - unique_id: zoe_req_hours
    state: >-
      {{ ((states('input_number.zoe_soc_upper_limit')|float(0) - states('sensor.byd_dolphin_soc')|int) /100*(states('input_number.car_2_battery')|int)/(states('sensor.template_car_2_season_power')|int) * 4)|round(0, 'ceil') / 4 }}

  - unique_id: zoe_charging_cost_last_period
    device_class: monetary
    unit_of_measurement: "kr"
    state: "{{ state_attr('sensor.zoe_kostnad','last_period')|float(0)|round(0) }}"

  - unique_id: car_2_range
    unit_of_measurement: "km"
    state: "{{ (states('sensor.template_zoe_battery')|int(0)*2.575)|round(0) }}"

  - unique_id: car_2_monthly_cost
    device_class: monetary
    unit_of_measurement: "kr"
    state: "{{ states('sensor.zoe_kostnad')|float(0) }}"
    name: 'Delphine Charge Cost'

## Tesla MY (car 1)
- sensor:
  - unique_id: car_1_season_power
    unit_of_measurement: "kW"
    device_class: power
    state: "{{ states('input_number.car_1_power_high')|int if now().month > 2 and now().month < 10 else states('input_number.car_1_power_low')|int }}"
    name: "Eazy laddeffekt (kW)"

  - unique_id: rya_charging_required_time
    name: "Required charging time Eazy"
    state: >-
      {%- set time = (states('sensor.tesla_charge_limit_soc')|float(0) - states('sensor.tesla_battery_level')|float(0)) /100*(states('input_number.car_1_battery')|int)/(states('sensor.template_car_1_season_power')|int) -%}
      {%- set hours = time|int -%}
      {%- set minutes = ((time - hours)*60)|int -%}
      {{ '{:02}:{:02}'.format(hours, minutes) }}
  - unique_id: rya_req_hours
    state: >-
      {{ ((states('sensor.tesla_charge_limit_soc')|float(0) - states('sensor.tesla_battery_level')|float(0)) /100*(states('input_number.car_1_battery')|int)/(states('sensor.template_car_1_season_power')|int) * 4)|round(0, 'ceil') / 4 }}

  - unique_id: rya_charging_power
    unit_of_measurement: "kW"
    device_class: power
    state_class: measurement
    name: "Eazy effekt (kW)"
    state: >-
      {% if is_state('sensor.chargenode_port1_state','3') -%}
        {{ states("sensor.template_chargenode_power_kw")|float(0) }}
      {%- else -%}
      {{ 0 | float }}
      {%- endif -%}
    
    # {{ states('sensor.chargenode_power_l1')|float(0) + states('sensor.chargenode_power_l2')|float(0) + states('sensor.chargenode_power_l3')|float(0) }}
  - unique_id: car_2_odometer
    unit_of_measurement: "km"
    name: 'Tesla Eazy Odometer'
    icon: mdi:counter
    state_class: total_increasing
    state: >-
      {{ states("sensor.tesla_odometer")|float(0)|round(0) }}
      
  - unique_id: rya_charging_cost
    device_class: monetary
    unit_of_measurement: "kr"
    state: "{{ states('sensor.template_rya_charging_power')|float(0) * states('sensor.template_elpris_kr')|float(0) }}"

  - unique_id: rya_charging_cost_last_period
    device_class: monetary
    unit_of_measurement: "kr"
    state: "{{ state_attr('sensor.rya_kostnad','last_period')|float(0)|round(0) }}"

  - unique_id: car_1_monthly_cost
    device_class: monetary
    unit_of_measurement: "kr"
    state: "{{ states('sensor.rya_kostnad')|float(0) }}"
    name: 'Tesla Eazy Charge Cost'

## Räkna ut bästa laddperiod
- trigger:
    - platform: time_pattern
      minutes: "/15"
    - platform: state
      entity_id: sensor.template_zoe_req_hours
      to:
    - platform: state
      entity_id: input_datetime.zoe_before
      to:
    - platform: state
      entity_id: sensor.template_rya_req_hours
      to:
    - platform: state
      entity_id: automation.zoe_charge
      to:
    - platform: state
      entity_id: automation.ladda_bilen_nar_det_ar_billigt
      to:
  sensor:
  - unique_id: next_charge
    device_class: timestamp
    name: "Charge period"
    state: >-
      {% set duration = states('sensor.template_zoe_req_hours')|float(0) if is_state('automation.zoe_charge','on') else 0 %}
      {% set duration = (duration + (states('sensor.template_rya_req_hours')|float(0) if is_state('automation.ladda_bilen_nar_det_ar_billigt','on') else 0)) %}
      
      {% set before = today_at(states('input_datetime.zoe_before'))+timedelta(minutes=5) 
          if now() < today_at(states('input_datetime.zoe_before')) 
          else today_at(states('input_datetime.zoe_before'))+timedelta(days=1,minutes=5) %}
      {% if not duration -%}
        unavailable
      {% elif duration <= 0%}
        unavailable
      {% else %}
        {% set grow = namespace(value=0) %}
        {% set priceDict = namespace(value = []) %}
        {% set prices = state_attr('sensor.nordpool_kwh_se3_sek_3_095_0','raw_today')|list %}
        {% set tomorrow = state_attr('sensor.nordpool_kwh_se3_sek_3_095_0','raw_tomorrow')|list%}
        {% if tomorrow | length > 1%}
          {% set prices = prices + tomorrow%}
        {% endif%}
        {% for p in prices%}
          {%set priceDict.value = priceDict.value + [(loop.index, (p.start, p.value))] %}
        {% endfor%}

        {% set dataDict = dict.from_keys(priceDict.value) %}
        {% set duration_quarters = (duration * 4)|int %}

        {% set priceDict.value = [] %}
        {% for p in dataDict.items() -%}
          {% set outerIndex = loop.index -%}
          {% if loop.index+duration_quarters-1 <= dataDict|length 
              and p[1][0]+timedelta(hours=duration) <= before -%}
            {% for i in range(duration_quarters) %}
              {% set grow.value = grow.value + dataDict[i+outerIndex][1] %}
            {% endfor %}
            {%- set val = (grow.value|float/duration_quarters)|round(2) %}
            {%- set grow.value = 0 %}
            {%- set priceDict.value = priceDict.value + [(p[1][0], val|round(2))] %}
          {% else %}
            {% set priceDict.value = priceDict.value + [(p[1][0], 999.9)] %}
          {% endif %}
        {% endfor %}
        {{ (priceDict.value|sort(attribute='0')|sort(attribute='1'))|map(attribute='0')|select('ge',now()-timedelta(minutes=55))|first }}
      {% endif %}
    attributes:
      periods_list: >-
        {% set duration = states('sensor.template_zoe_req_hours')|float(0) if is_state('automation.zoe_charge','on') else 0 %}
        {% set duration = (duration + (states('sensor.template_rya_req_hours')|float(0) if is_state('automation.ladda_bilen_nar_det_ar_billigt','on') else 0)) %}
        {% set before = today_at(states('input_datetime.zoe_before'))+timedelta(minutes=5) 
            if now() < today_at(states('input_datetime.zoe_before')) 
            else today_at(states('input_datetime.zoe_before'))+timedelta(days=1,minutes=5) %}
        {% set grow = namespace(value=0) %}
        {% set priceDict = namespace(value = []) %}
        {% set prices = state_attr('sensor.nordpool_kwh_se3_sek_3_095_0','today')|list %}
        {% set tomorrow = state_attr('sensor.nordpool_kwh_se3_sek_3_095_0','tomorrow')|list%}
        {% if tomorrow | length > 1%}
          {% set prices = prices + tomorrow%}
        {% endif%}
        {% for p in prices -%}
          {% set priceDict.value = priceDict.value + [(loop.index-1, p)] -%}
        {% endfor -%}

        {% if duration == 0%}
          []
        {% else %}    
          {% set dataDict = dict.from_keys(priceDict.value) %}
          {% set duration_quarters = (duration * 4)|int %}

          {% set priceDict.value = [] %}
          {% for p in dataDict.items() -%}
            {% set outerIndex = loop.index -%}
            {% if loop.index+duration_quarters-1 <= dataDict|length -%}
              {% for i in range(duration_quarters) -%}
                {% set grow.value = grow.value + dataDict[i+outerIndex-1] -%}
              {% endfor -%}
              {% set val = (grow.value|float/duration_quarters)|round(2) %}
              {% set grow.value = 0 %}
              {% set priceDict.value = priceDict.value + [(p[0], val)] %}
            {% else %}
              {% set priceDict.value = priceDict.value + [(p[0], 999.9)] %}
            {% endif %}
          {% endfor %}
          {% set data = dict.from_values(priceDict.value).items()|sort(attribute='0')|sort(attribute='1') %}
          {% set output = namespace(value=[]) %}
          {% for d in data -%}
            {% if d[1] < 999 -%}
              {% set m1 = ((d[0]/4 - (d[0]/4)|int)*60)|int -%}
              {% set h1 = (d[0]/4)|int -%}
              {% set start_time = now().replace(hour=0, minute=0, second=0, microsecond=0) + timedelta(hours=h1, minutes=m1) %}
              {% set end_time = start_time + timedelta(hours=duration) %}
              {% if start_time >= now() and end_time <= before -%}
                {% set t1 = '%02d:%02d' % (h1 if h1<24 else h1-24, m1) -%}
                {% set time1 = t1 if h1<24 else t1 ~ '⁺¹' -%}
                {% set duration_hours = duration|int -%}
                {% set duration_mins = ((duration - duration_hours)*60)|int -%}
                {% set end_hour = h1 + duration_hours -%}
                {% set end_min = m1 + duration_mins -%}
                {% if end_min >= 60 -%}
                  {% set end_hour = end_hour + 1 -%}
                  {% set end_min = end_min - 60 -%}
                {% endif -%}
                {% set hour2 = '%02d' % (end_hour if end_hour<24 else end_hour-24) -%}
                {% set min2  = ':%02d' % end_min if end_hour<24 else ':%02d⁺¹' % end_min -%}
                {% set time2 = hour2 ~ min2 -%}
                {% set output.value = output.value + ['%s-%s: %s' % (time1, time2, d[1]|round(2))] -%}
              {% endif %}
            {% endif %}
          {% endfor -%}
          {{ output.value }}          
        {% endif %}

  - unique_id: next_charge_time
    state: "{{ states('sensor.template_next_charge')|as_timestamp(default=none)|timestamp_custom('%H:%M', default='—') }}"

  - unique_id: next_low_price
    state: >-
      {% set priceDict = namespace(value = []) -%}
      {% set prices = state_attr('sensor.nordpool_kwh_se3_sek_3_095_0','raw_today')|list -%}
      {% set tomorrow = state_attr('sensor.nordpool_kwh_se3_sek_3_095_0','raw_tomorrow')|list -%}
      {% if tomorrow | length > 1 -%}
        {% set prices = prices + tomorrow -%}
      {% endif -%}
      {% for p in prices -%}
        {% set priceDict.value = priceDict.value + [(loop.index, (p.start, p.value))] -%}
      {% endfor -%}
      {% set dataDict = dict.from_keys(priceDict.value) -%}
      {% set priceDict.value = [] -%}
      {% for p in dataDict.items() -%}
        {% if (dataDict[loop.index][0] >= now() and (dataDict[loop.index][1]|float) < state_attr('sensor.nordpool_kwh_se3_sek_3_095_0', 'average')|float) -%}
          {% set priceDict.value = priceDict.value + [dataDict[loop.index][0]] -%}
        {% endif -%}
      {% endfor -%}
      {% if priceDict.value -%}
      {{ (priceDict.value|first).strftime('%H:%M') }}
      {% else -%}
        undefined
      {% endif -%}